<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Verificador QR - Gueparsex Party</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      text-align: center;
    }
    #reader {
      width: 300px;
      margin: auto;
    }
    #resultado {
      margin-top: 20px;
      font-size: 1.2rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>üì≤ Esc√°ner QR - Entrada</h2>
  <div id="reader"></div>
  <div id="resultado">Esperando escaneo...</div>

  <script>
    function verificarEntrada(id) {
      fetch(`https://gueparsex-backend.vercel.app/verificar`, {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ qrData: id })
	    })

        .then(res => res.json())
        .then(data => {
          if (data.error) {
            document.getElementById('resultado').innerText = '‚ùå Entrada no v√°lida';
          } else if (data.valido) {
            document.getElementById('resultado').innerHTML = `
              ‚úÖ Entrada v√°lida<br>
              Nombre: ${data.nombre}<br>
              C√©dula: ${data.cedula}<br>
              Tipo: ${data.tipoEntrada}
            `;
          } else {
            document.getElementById('resultado').innerText = '‚ö†Ô∏è Entrada ya fue utilizada';
          }
        })
        .catch(() => {
          document.getElementById('resultado').innerText = '‚ùå Error al verificar';
        });
    }

    const scanner = new Html5Qrcode("reader");

   Html5Qrcode.getCameras().then(cameras => {
  if (cameras && cameras.length) {
    // Buscar c√°mara trasera si es posible
    const backCamera = cameras.find(cam => cam.label.toLowerCase().includes('back')) || cameras[0];

    scanner.start(
      backCamera.id,

          {
            fps: 10,
            qrbox: 250
          },
          qrCodeMessage => {
            scanner.stop();
            verificarEntrada(qrCodeMessage);
            setTimeout(() => {
              document.getElementById('resultado').innerText = 'Esperando escaneo...';
              scanner.start(cameras[0].id, { fps: 10, qrbox: 250 }, qrCodeMessage => {
                scanner.stop();
                verificarEntrada(qrCodeMessage);
              });
            }, 5000); // espera 5 segundos antes de volver a escanear
          },
          error => {
            // No mostrar errores de escaneo
          }
        );
      }
    });
  </script>
</body>
</html>
